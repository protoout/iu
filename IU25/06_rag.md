# RAGを使った「盛岡の観光アドバイザーAIチャットボット」を作ろう

- 現状作成したAIは事前に学習している盛岡観光のアドバイスができます。  
  ですが、リアルタイムな情報や地域特有のローカルな情報などについては把握していません。
- ここではAIに“外部データを検索する仕組み”を連携させて、特定の知識に強いAIを作っていきましょう。

## RAGに触れてみよう

生成AIは、特定の分野の情報に関して知らないことがあった場合に、存在しない情報を生成して“それっぽいウソ”をつくことがあります。 （=ハルシネーション）  
そのようなハルシネーションを防ぐために今回はRAGという手法を扱っていきます。

### RAG（Retrieval-Augmented Generation）って何?

RAG（Retrieval-Augmented Generation）は、AIが回答を作る前に**関連する資料を検索して**、見つけた情報を**根拠**として使いながら回答する方法です。  

| 略 | 意味 | やること |
|---|---|---|
| R | Retrieval（検索） | 必要な情報を Web / 資料 / DB / ファイル から探す |
| A | Augmented（補強） | 見つけた情報を根拠として LLM に渡す |
| G | Generation（生成） | 根拠をもとに、読みやすい文章で答える |

### LLMだけ vs RAGあり

- 02.llmでご紹介した、「LLMだけではあと一歩足りないところ」をRAGありだと以下のように解決できます。

| やりたいこと | LLM単体 | RAGあり |
|---|---|---|
| 「学内/ゼミのルールを確認したい」 | 一般論でそれっぽく答えがち（根拠が弱い） | **配布資料や規約の該当箇所**を探して、それを根拠に答えられる |
| 「講義資料PDFの内容を噛み砕いてほしい」 | 参照できないと「見れません」「推測です」になりがち | **PDFから該当部分を検索**して、要点を短く整理して説明できる |
| 「ローカルでニッチな情報を知りたい」 | 知らないことは想像で埋めがち | **手元の資料に書かれている範囲**なら、根拠ベースで答えられる |

### RAGを入れる前に試してみよう

- 盛岡のローカルな観光情報をAIに与える前に、質問を送ってみましょう。  
  - RAGを入れた後で回答にどのような変化が起きるかを試していきます。

1. 今回は盛岡のローカルな観光情報の知識（ナレッジ）を扱っていきます。
[盛岡のローカル観光情報ナレッジ](https://gist.githubusercontent.com/n0bisuke/a6d77572f3b55e9755e0580ebea2414d/raw/c37cb9a96318eb9b1615b7276628230dbb5dd88e/morioka-oyako.md)を開いてみてください。

2.下記をコピーして先ほど作成したチャットボットに貼り付けて聞いてみましょう。
（質問文いくつか下記のフィードバックからもってきてください。）

    ```txt
    直利庵本店の最低予約人数、大人料金と小学生料金は？
    ```
  - 作成したチャットボットでも、`公式な公開情報はありません`という事実と異なる答えが返ってきたので、ハルシネーションが起きていることが確認できます


3.現状は「〜〜〜」とローカルな観光情報が返ってこず、それっぽい嘘の情報が返ってきていてハルシネーションがおきています。

  <img src="https://i.gyazo.com/4267d93864c4eb345671d70277672836.png" width="450px" alt="image from gyazo"/>

- 参考リンク
  - [漫画で理解するRAGの説明](https://note.com/preview/nbcd4a100e8c7?prev_access_key=a430d90f75599f57e6ee9654730312d2)


## 1. 作るアプリケーション

### 1-1. ローカル情報について質問すると、資料を参照しながら正しく回答してくれるAIチャットボット

- Difyのナレッジ機能を使ってRAGを構築します
- 事前に用意した資料を検索して、その内容を根拠に回答できるチャットボットを作ります

  <img src="https://i.gyazo.com/e8cb69a64fbb355b3e8bb17ea7989f36.png" width="450px" alt="image from gyazo"/>

### 1-2. スタート準備

- 現時点で、Difyが以下の状態になっていればOKです
  - 前のパートで作った **盛岡の観光アドバイザーチャットボット** がある
  - そのチャットボットが **プレビューで会話できる**状態になっている

    <img src="https://i.gyazo.com/5dff5672c3a73f6332d0efb8ae885c61.png" width="450px" alt="image from gyazo"/>

## 2. ハンズオン：RAGを使った盛岡の観光アドバイザーAIチャットボットを作ろう

### 2-1. ナレッジデータを登録しよう

- [こちらのURL](https://gist.githubusercontent.com/n0bisuke/a6d77572f3b55e9755e0580ebea2414d/raw/c37cb9a96318eb9b1615b7276628230dbb5dd88e/morioka-oyako.md)を開き、ファイルとして保存します
`morioka-oyako.md`または`morioka-oyako.txt`という名前で自分のパソコンに保存してください

    <img src="https://i.gyazo.com/5d03e8e9fa1725f0f27e2c9f9046283d.png" width="150px" alt="image from gyazo"/>

補足: zipでまとめてDLしたい人は[こちら](https://gist.github.com/n0bisuke/a6d77572f3b55e9755e0580ebea2414d)

<details>
  <summary>ファイル記載内容</summary>

# 盛岡観光完全ガイド

## 盛岡冷麺専門情報

盛岡冷麺は1954年に焼肉レストラン「食道園」で誕生した盛岡市を代表するご当地グルメです朝鮮半島の平壌冷麺をベースに、日本人の味覚に合わせて改良を重ねました最大の特徴は、小麦粉と片栗粉をブレンドした独特のコシの強い麺で、一度食べると忘れられない食感ですスープは牛骨を12時間以上煮込んだ透明で澄んだスープで、キムチの辛味と酸味が絶妙にマッチしますトッピングには茹で卵、きゅうり、そして盛岡冷麺ならではの季節の果物（梨、スイカ、リンゴなど）が添えられ、甘味が全体の味をまろやかにします代表的な店舗「ぴょんぴょん舎盛岡駅前店」は盛岡駅東口から徒歩3分の好立地で、営業時間は11:00-22:00（ラストオーダー21:30）、年中無休で営業しています価格帯は並盛880円、中盛1,080円、大盛1,280円とリーズナブルで、学生からサラリーマン、観光客まで幅広い層に愛されています店内は120席の大型店舗で、平日昼間は比較的空いているため、ゆっくり食事を楽しめます土日祝日や夏季は行列ができることもあるので、開店直後の11:00-12:00または午後の15:00-17:00の時間帯がおすすめです食道園本店は大通2-5-8にあり、より伝統的な味を楽しめます営業時間は17:00-23:30で日曜定休、価格は若干高めですが本格的な味わいが堪能できます盛岡駅からは徒歩12分、タクシーで5分程度です

=====
冷たい麺料理 夏にさっぱり 韓国風スープ 果物トッピング コシの強い麺
=====
11時開店 22時閉店 盛岡駅前立地 徒歩3分アクセス良好 年中無休
=====
880円から1280円 リーズナブル 学生でも利用可能 120席大型店舗
=====
1954年誕生 食道園発祥 朝鮮半島平壌冷麺ベース 牛骨12時間煮込みスープ

## わんこそば体験情報

わんこそばは江戸時代末期から明治時代にかけて岩手県で発達した郷土料理で、現在では盛岡市の代表的な観光体験となっています一口大のそばを次々と小さなお椀に入れて食べる独特のスタイルで、給仕さんが「はい、じゃんじゃん」「はい、どんどん」の掛け声とともに、食べ終わるや否やすかさず次のそばを椀に入れ続けますこれは南部藩時代の「そば振る舞い」という客人をもてなす文化が起源とされ、一杯でも多く食べてもらいたいという主人の心遣いから生まれました満腹になったら椀に蓋をして「ごちそうさま」の合図をします平均的な摂取量は成人男性で50-70杯、女性で30-50杯程度ですが、これは通常のそば一人前とほぼ同量です直利庵本店（中ノ橋通1-8-3）は明治17年創業の老舗で、営業時間は11:00-20:00、2名以上から予約可能で料金は大人3,500円、小学生2,500円です所要時間は約1時間で、完食後は記念品として手形がもらえます盛岡駅からは徒歩15分、市内循環バス「県庁・市役所前」下車徒歩5分です東家本店は同じ住所にあり、営業時間11:00-21:00、料金も同額ですが、より歴史ある建物で伝統的な雰囲気を楽しめます店内では岩手の民謡「南部牛追唄」が流れ、給仕さんの威勢の良い掛け声とともに、まさに岩手の文化体験ができます団体予約も可能で、修学旅行生や企業の懇親会にも利用されています

=====
江戸時代郷土料理 一口サイズそば 小さなお椀 次々と食べる独特スタイル
=====
はいじゃんじゃん はいどんどん 威勢の良い掛け声 椀に蓋をして終了合図
=====
男性50-70杯 女性30-50杯 所要時間1時間 記念品手形がもらえる
=====
直利庵本店 東家本店 中ノ橋通 11時開始 大人3500円 2名以上予約

## 石川啄木記念館詳細情報

石川啄木は1886年（明治19年）2月20日に岩手県南岩手郡日戸村（現在の盛岡市玉山区日戸）で生まれ、本名を石川一（はじめ）と言いました盛岡中学校在学中から文学に親しみ、与謝野鉄幹の「明星」に短歌を投稿するなど早くから才能を発揮しました1905年に中学校を卒業間近で退学し、上京して文学活動に専念しましたが、生活は困窮を極めました1906年に故郷に戻り、渋民尋常小学校で代用教員として約1年間勤務しましたが、この時期の体験が後の作品に大きな影響を与えました石川啄木記念館は玉山区渋民字渋民9番地にあり、啄木が代用教員時代を過ごした渋民の地に建設されました開館時間は9:00-17:00（入館受付は16:30まで）、休館日は月曜日（祝日の場合は翌日）と年末年始です入館料は大人300円、高校生200円、小中学生100円で、20名以上の団体は2割引になります館内には啄木の生涯を追った常設展示のほか、直筆原稿約200点、書簡類約150点、生活用品約100点が展示されています特に「一握の砂」「悲しき玩具」の原稿は貴重で、啄木の心境の変化を直接感じることができます隣接する旧渋民尋常小学校は啄木が教鞭をとった学校を復元したもので、当時の教室の様子を再現しています盛岡駅からはバスで約30分、「渋民」バス停下車徒歩5分です車の場合は東北自動車道盛岡ICから約15分で、無料駐車場が50台分あります

=====
1886年明治19年岩手県生まれ 石川一本名 代用教員経験 渋民尋常小学校
=====
9時開館 17時閉館 月曜休館 大人300円 高校生200円 小中学生100円
=====
直筆原稿200点 書簡150点 生活用品100点 一握の砂悲しき玩具原稿
=====
渋民バス停徒歩5分 盛岡駅からバス30分 無料駐車場50台 盛岡IC15分
</details>

### 2-2 ナレッジベースを作成

1. [ナレッジ機能](https://cloud.dify.ai/datasets)に移動します  

    <img src="https://i.gyazo.com/6d37cc15a7954a2bc22f1152e49af3c9.png" width="450px" alt="image from gyazo"/>

2. 画面左上の`+ナレッジベースを作成`をクリックします

    <img src="https://i.gyazo.com/00293973083117c298714eb8c38e4236.png" width="450px" alt="image from gyazo"/>

3. 先ほど保存したファイル（`morioka-oyako.md` など）をドラッグアンドドロップでアップロード

    <img src="https://i.gyazo.com/44b34ca32a8699bbced5a4b206601d51.png" width="450px" alt="image from gyazo"/>

4. 実際にアップロードすると、「次へ」というボタンが表示されるのでそのボタンをクリック

    <img src="https://i.gyazo.com/6b9699b09e8a5b17d964195335e7dc1c.png" width="450px" alt="image from gyazo"/>

### 2-3. 埋め込み

1. 基本汎用設定で良いですが、今回は精度を優先して `親子分割モード` を選択します

    <img src="https://i.gyazo.com/a7ed0fb494e320d45de9bf2873198bd3.png" width="450px" alt="image from gyazo"/>

2. チャンク識別子と検索用子チャンク識別子は以下に書き換えましょう
- チャンク識別子: `##`
- 検索用子チャンク識別子: `=====`

    <img src="https://i.gyazo.com/609e339e1339dd94154e381a12c0d2a9.png" width="450px" alt="image from gyazo"/>

3. 埋め込みモデル
- 受講生の皆さんはGeminiがデフォルトで入っているかと思いますが、クリックして「gemini-embedding-001」というモデルを選びましょう

    <img src="https://i.gyazo.com/f39519002fae379e54e92b2e55046c71.png" width="450px" alt="image from gyazo"/>

### 2-4.検索設定をして保存しよう

- 本来は「ハイブリッド + リランカー」の方が精度が高い
- ただリランカーは別途APIキーが必要な場合があるので、今回はウェイト設定で進めます

1. ベクトル検索、全文検索、ハイブリッド検索の中から、`ハイブリッド検索` を選択

    <img src="https://i.gyazo.com/8c43d475ce1b25f798b3d9cb24c416f7.png" width="450px" alt="image from gyazo"/>

2. `ウェイト設定` を選択

    <img src="https://i.gyazo.com/fc14ea2b1739476acf83fc96f5b71a97.png" width="450px" alt="image from gyazo"/>

3. `保存して処理` を押す
- 最後に、「保存して処理」のボタンをクリックしましょう
- このとき多少埋め込み処理時間があります

    <img src="https://i.gyazo.com/6782e5a33d0a533d1b7cc2fcb21952c1.png" width="450px" alt="image from gyazo"/>

> [!CAUTION]
> 下記画像のように`埋め込み処理が完了しました`の表記が出たら、完了している合図です  
> <img src="https://i.gyazo.com/bde4a5a225ba4c79c6a81380257cb3c4.png" width="450px" alt="image from gyazo"/>

4. `ドキュメントに移動`をクリック

    <img src="https://i.gyazo.com/e4311250b72841b277afd46062218626.png" width="450px" alt="image from gyazo"/>

5. ナレッジ追加の確認
- 右側のステータスが利用可能になっているか確かめましょう

    <img src="https://i.gyazo.com/b355dd66cc8543274e0359f40047342a.png" width="450px" alt="image from gyazo"/>

### 2-5. チャットフローに「知識検索ノード」を追加

1. 画面上部の「スタジオ」タブをクリックして、最初に作ったチャットフローの画面に戻り、自分のチャットアプリを開きましょう

    <img src="https://i.gyazo.com/d346623b6c7942da8ca3a11226692bad.png" width="450px" alt="image from gyazo"/>

2. 知識検索ノードを追加する
- `開始ノード` と `LLMノード` を繋ぐ線の上にカーソルを持っていくと、`+マーク`がでます

    <img src="https://i.gyazo.com/ce641441280e456578804d1c919a4675.png" width="450px" alt="image from gyazo"/>

- その`+マーク`をクリックして、 `知識検索` ノードを追加します

    <img src="https://i.gyazo.com/f1b31a4a0ce4a2294c650d1bdb5170cd.png" width="450px" alt="image from gyazo"/>

- 4つのノードが並びました

    <img src="https://i.gyazo.com/c07911c0b224983db30572af072312fd.png" width="450px" alt="image from gyazo"/>

### 2-6. 知識検索ノードの設定でナレッジを紐づける

- ここから知識検索ノードをクリックして、右側の画面で設定していきます

    <img src="https://i.gyazo.com/5baf19bc878348331fad2d31824c33c8.png" width="450px" alt="image from gyazo"/>

1. ナレッジベース項目の右側にある`+`をクリックします

    <img src="https://i.gyazo.com/0a5e05fc89e439ecbdee334c47c0b7ff.png" width="450px" alt="image from gyazo"/>

2. 先ほど作成したナレッジを選択して、`追加`をクリックします

    <img src="https://i.gyazo.com/f88dc73902a2f7c7c202a581bb811b54.png" width="450px" alt="image from gyazo"/>

3. ナレッジベースが登録されました

    <img src="https://gyazo.com/6e0fe598a6be8a8cd889a368e2a40e05.png" width="450px" alt="image from gyazo"/>

4. 次にLLMノードをクリックして右側の画面で設定していきます
- 入れるモデルは`Gemini 2.0 Flash-Lite 001`を選びます

> [!TIP]
> RAGが効いていることを分かりやすくするため、あえて少し古めのモデルを使います  
> (賢すぎるモデルだと、RAGなしでも答えてしまうことがあります）  
> <img src="https://i.gyazo.com/93a33031303a9e50de4d3d5a4e57142e.png" width="450px" alt="image from gyazo"/>

5. 設定
- コンテキストの「変数値を設定」の欄をクリックして、知識検索の中の`result`を選びましょう 

    <img src="https://i.gyazo.com/7a2138ec292a26b29c610dc949c8bb5e.png" width="450px" alt="image from gyazo"/><br>

    <img src="https://i.gyazo.com/b1299412977579fcb86909c8b44ee624.png" width="450px" alt="image from gyazo"/>

6. プロンプトをRAG用に調整
- LLMノードのSYSTEMの中に現在入っているプロンプトは削除し、以下のプロンプトをコピーして置き換えましょう

```
## 役割
- あなたは盛岡の観光アドバイザーです
- ユーザーからの質問に対して盛岡観光に役立つ情報を提供してください
- コンテキストに基づいて回答してください

{{#context#}}

## 制約事項
- ユーザーが不快に思う返信は禁止です
```

> [!TIP]
> コンテキストは、きちんと紫色で変数として入っているか確認しましょう
> 
> <img src="https://i.gyazo.com/1868c1034865e2ffec19e8314a59bb3e.png" width="450px" alt="image from gyazo"/>

### 2-7. 動かしてみよう

ここで **2-1で送ったものと同じ質問** をプレビュー画面でもう一度聞きます  
RAGを入れたことでの差を体験しましょう

```txt
直利庵本店の最低予約人数、大人料金と小学生料金は？
```

チェックポイント
- 回答が登録したナレッジの情報通り答えられていれば成功です
- 資料にないことを断定する場合は、プロンプトを調整しましょう
  - 参考：[RAGの精度が上がらない？設定を見直してみよう！](https://protoout.studio/2296077e488780f081dace683bb63f86)

    <img src="https://i.gyazo.com/e8cb69a64fbb355b3e8bb17ea7989f36.png" width="450px" alt="image from gyazo"/>

### 2-8 公開して試そう

1. 画面右上の`公開`するをクリックし、`更新を公開`ボタンを押します

    <img src="https://i.gyazo.com/b66569ab623f4d957cd11406afea8a0d.png" width="300px" alt="image from gyazo"/>

2. `アクションが成功しました`が表示されたらOKです

    <img src="https://i.gyazo.com/86dff25ab402ecbd30794931e743017d.png" width="300px" alt="image from gyazo"/>

3. `実行`ボタンをクリックして早速試してみましょう！

    <img src="https://i.gyazo.com/e207e9745453366d225ae663b2981510.png" width="300px" alt="image from gyazo"/>

## 3. Tips: RAGの限界と応用

- RAGは「事前に登録した情報」が中心ですが、リアルタイム性が高い情報や更新性が高い情報を扱うためにはそういったデータを提供している外部サービス（API）と連携する必要があります   
「Webhookを利用して外部サービスと連携する」というものもあります  
  - 例：[お天気API](https://weather.tsukumijima.net/)   
  - JSONという書き方が少し難しいですが、チャレンジすると応用の幅が広がると思います！

## 4. チャレンジ課題

時間が余っている人はこちら
プロンプトを書き換えてみたり、自分の大学のHPを読みこんでみるなど、オリジナル会話型AIを作ってみましょう！

1. LINE Botで動かせるようにして、周りの人との共有してみよう
2. ナレッジデータにない情報は回答しないよう、プロンプトを調整してみよう
3. 盛岡ではなく「自分の大学/職場/施設」の情報でナレッジを追加してみよう

## 5. まとめ

生成AIだけだと、ローカル情報は学習されていないことが多く、もっともらしい誤回答（ハルシネーション）が起きやすいため、このパートでは「資料を検索して、その内容を根拠に回答する」RAGという仕組みで、回答の精度と再現性を上げました

DIfyには、エクセルファイルやNotionの内部ページなど、扱えるデータが多く搭載されているので、 大学の案内・学内ルール・サークル情報などにも応用して、様々なAIチャットボットを作成することができます

---

このページの内容は以上です  

[◀ 目次ページ](./readme.md)
