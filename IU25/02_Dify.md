## 1. Difyで簡単なチャットアプリを作る
まずはDifyでチャットを作っていきましょう。以下の資料を元に進めます。

記事内にあるプロンプトは秋葉原ではなく **「盛岡の観光アドバイザー」** というプロンプトにして試してみましょう。
https://zenn.dev/protoout/articles/81-start-dify-chatflow

---

## 2. モデルプロバイダーをGeminiへ
無料枠があるGeminiのAPIキーを設定しましょう。  
デフォルトだとGPT系はちょっとは使えるけどすぐ制限が来てしまう。

### 2-1. GeminiのAPI取得
Google AI StudioからAPIキーを取得します。

### 2-2. Difyのモデルプロバイダー設定
Difyはモデルプロバイダーという画面から各種AIモデルを追加できます。

- CleanShot 2025-08-09 at 12.39.07.png

OpenAIのAPIキーがある人はOpenAIを使うなど、他のAPIでもOKです。

- CleanShot 2025-08-09 at 12.55.39.png

**手順**
1. モデルプロバイダー > Gemini > セットアップ と進む
2. APIキーをセットする

- CleanShot 2025-08-09 at 12.57.02.png
- CleanShot 2025-08-09 at 12.57.09.png（セット成功）

これである程度使っても無料で制限も緩和されてAIが利用できます。

※制限が来ないとは言い切れないので、その場合は[Groq]https://qiita.com/n0bisuke/private/1876d66f15ea190d3f8f#:~:text=%E3%81%9D%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AF-,Groq,-%E3%81%AEAPI%E3%81%A8のAPIとモデルプロバイダーを利用するのがお勧めです。  
余裕ある人はGroqのAPIキーも発行しておくと後で遊べるかもです。

---

## 3. RAGアプリを作成
ナレッジ機能を使い、検索拡張機能を付与しましょう。

盛岡のナレッジや組織内のナレッジなどローカル情報には生成AIは弱く、学習してない情報に対してそれっぽい間違った回答を生成することがあります。ハルシネーションと言います。

これを回避するために、AIに情報と検索機能を持たせてあげて、回答精度を上げる手法をRAGと呼びます。

### 3-0. RAGの解説
https://note.com/preview/nbcd4a100e8c7?prev_access_key=a430d90f75599f57e6ee9654730312d2

### 3-1. 利用するナレッジをDL
https://gist.githubusercontent.com/n0bisuke/a6d77572f3b55e9755e0580ebea2414d/raw/c37cb9a96318eb9b1615b7276628230dbb5dd88e/morioka-oyako.md

- ↑こちらのテキストを `morioka.txt` か `morioka.md` などのファイル名で手元に保存しましょう。

- CleanShot 2025-08-09 at 13.07.42.png

直接DLしたい人は[こちら](https://gist.github.com/n0bisuke/a6d77572f3b55e9755e0580ebea2414d)からzipでDLできます。 

### 3-2. ナレッジデータを登録
**手順**
1. ナレッジのメニューに移動
https://cloud.dify.ai/datasets

2. 「ナレッジベースを作成」を選択
3. 先ほどのファイルをアップロード

- CleanShot 2025-08-09 at 13.04.14.png
- CleanShot 2025-08-09 at 13.05.07.png
- CleanShot 2025-08-09 at 13.10.43.png

### 3-3. 埋め込み（親子分割モード）と検索設定

#### 埋め込み: チャンク設定
- 親子の方が基本的には精度高いです
- 汎用の方が簡単だけど、僕が勉強したかったので親子分割モードにします

- CleanShot 2025-08-09 at 13.11.33.png

**設定値**
- チャンク識別子: `##`
- 検索用子チャンク識別子: `=====`

#### 埋め込み: インデックス方法
Geminiの埋め込みモデルを利用

- CleanShot 2025-08-09 at 13.13.47.png

#### 検索: 検索設定
- ハイブリッドのリランク設定が一番良い
- リランカーはAPIキーが欲しいので今回はウェイトで

**手順**
- ハイブリッド検索 > ウェイト設定

- CleanShot 2025-08-09 at 13.14.26.png

保存して処理で完了

- CleanShot 2025-08-09 at 13.16.37.png

### 3-4. チャットフローで設定
チャットフローに機能追加してみましょう。

**手順**
1. 最初に作ったチャットフローの画面に戻る
2. 開始ノードとLLMノードの間に知識検索ノードを入れる
3. 知識検索ノードの設定 > ナレッジベースの項目の `+`
4. 先ほど作成したナレッジを選択 > 追加

- CleanShot 2025-08-09 at 13.17.31.png
- CleanShot 2025-08-09 at 13.18.15.png
- CleanShot 2025-08-09 at 13.19.12.png（追加確認）

#### LLMモジュールの設定
- Gemini 1.5 Flashなど、ちょっと昔のあまり頭がよくないモデルを利用してみます  
  （頭の良いモデルを使うとRAG関係なくちゃんと回答してくれる懸念）

- CleanShot 2025-08-09 at 13.19.40.png

**コンテキスト設定**
- コンテキストの箇所に知識検索の `result` を設定します

- CleanShot 2025-08-09 at 13.20.02.png

#### プロンプトを調整
以下を貼り付け。

## 役割
- あなたは盛岡の観光アドバイザーです。
- ユーザーからの質問に対して盛岡観光に役立つ情報を提供してください。
- コンテキストに基づいて回答してください。

{{#context#}}

## 制約事項
- ユーザーが不快に思う返信は禁止です。

こんな感じ。これでOKです。

- CleanShot 2025-08-09 at 13.24.36.png

### 3-5. 試す
プレビューでチャットして試しましょう。

---

## 4. 追加機能も入れてみる（時間次第）
- 何かプラグイン使ってみましょう
- スクレイピング？

---

## 5. LINEのプラグインでLINE Bot化
さて、いよいよLINE連携しましょう...
https://zenn.dev/n0bisuke/scraps/3fdf49f46ae9b1

……と思ったのですが、Difyのバグにあたってしまいまして、プラグイン設定がおそらくうまくいかないです。

- 既知のバグ
- ブラウザ変えたりアカウント変えたりと色々検証しましたが厳しそうでした。

（プラグインを使わずに〜 の代替手順がここに入る想定）

---

## 6. GPT5かgpt-ossも使ってみる（おまけ）
- Hugging FaceのAPIでgpt-oss使ってみましょう
- GPT5 APIキーあればいける

---

## 7. 自由時間
- 色々作ってみてね

---

## 8. まとめ
- DifyでAIチャットアプリ作れた
- RAG機能も使ってみた
- LINE Bot作れた
